name: Update Docker Hub README

on:
  push:
    branches:
      - docker
    paths:
      - 'README.md'

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get changed files
        id: changed_files
        uses: tj-actions/changed-files@v41

      - name: Update Docker Hub README
        if: contains(steps.changed_files.outputs.all_changed_files, 'README.md')
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          apt-get update && apt-get install -y jq
          TOKEN=$(curl -s -H "Content-Type: application/json" -X POST -d '{"username": "'"$DOCKER_USERNAME"'", "password": "'"$DOCKER_PASSWORD"'"}' https://hub.docker.com/v2/users/login/ | jq -r .token)
          curl -X PATCH https://hub.docker.com/v2/repositories/robinmeis/tiktok-live-recorder/ \
            -H "Content-Type: application/json" \
            -H "Authorization: JWT ${TOKEN}" \
            -d '{"full_description": "'"$(sed ':a;N;$!ba;s/\n/\\n/g' README.md)"'"}'
